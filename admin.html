<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>এডমিন প্যানেল</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    
    <div id="login-section" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 300px;">
            <h2 style="text-align: center;">এডমিন লগইন</h2>
            <form id="login-form">
                <input type="email" id="admin-email" class="admin-input" placeholder="ইমেইল" required>
                <input type="password" id="admin-pass" class="admin-input" placeholder="পাসওয়ার্ড" required>
                <button type="submit" class="buy-btn">প্রবেশ করুন</button>
            </form>
        </div>
    </div>

    <div id="dashboard-section" class="admin-container" style="display: none;">
        <div class="sidebar">
            <h3>এডমিন প্যানেল</h3>
            <a href="index.html" class="nav-link" style="display:block; margin-bottom: 20px; color: var(--primary);"><i class="fas fa-home"></i> হোম পেইজে যান</a>
            
            <a onclick="showSection('products')" style="display:block; cursor:pointer; margin-bottom:10px;">বই আপলোড/এডিট</a>
            <a onclick="showSection('banners')" style="display:block; cursor:pointer; margin-bottom:10px;">ব্যানার</a>
            <a id="logout-btn" style="display:block; cursor:pointer; color:red;">লগআউট</a>
        </div>

        <div class="main-content">
            <div id="sec-products">
                <h2>বই ম্যানেজমেন্ট</h2>
                <form id="upload-form" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <input type="hidden" id="edit-id"> <input type="text" id="book-title" class="admin-input" placeholder="বইয়ের নাম" required>
                    <input type="text" id="book-author" class="admin-input" placeholder="লেখকের নাম">
                    
                    <select id="book-category" class="admin-input" required>
                        <option value="">ক্যাটাগরি সিলেক্ট করুন</option>
                        <option value="HSC">HSC একাডেমিক</option>
                        <option value="Admission">এডমিশন টেস্ট</option>
                        <option value="Novel">উপন্যাস</option>
                        <option value="Science">বিজ্ঞান</option>
                        <option value="History">ইতিহাস</option>
                    </select>

                    <input type="number" id="book-price" class="admin-input" placeholder="দাম" required>
                    <input type="url" id="book-image" class="admin-input" placeholder="ছবির লিংক" required>
                    <textarea id="book-desc" class="admin-input" rows="5" placeholder="বিবরণ..."></textarea>
                    
                    <button type="submit" id="submit-btn" class="buy-btn">আপলোড করুন</button>
                    <button type="button" id="cancel-edit" class="buy-btn" style="background: #666; display: none; margin-top: 5px;">বাতিল করুন</button>
                </form>

                <h3>বইয়ের তালিকা (এডিট করতে ক্লিক করুন)</h3>
                <div id="admin-book-list" style="display: grid; gap: 10px;"></div>
            </div>

            <div id="sec-banners" style="display: none;">
                <h2>স্লাইডার ব্যানার</h2>
                <form id="banner-form">
                    <input type="url" id="banner-img" class="admin-input" placeholder="ব্যানার ছবির লিংক" required>
                    <button type="submit" class="buy-btn">ব্যানার যুক্ত করুন</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from './firebase-config.js';

        const loginSec = document.getElementById('login-section');
        const dashSec = document.getElementById('dashboard-section');

        // Auth Check
        onAuthStateChanged(auth, user => {
            if(user) { loginSec.style.display = 'none'; dashSec.style.display = 'flex'; loadAdminBooks(); }
            else { loginSec.style.display = 'flex'; dashSec.style.display = 'none'; }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('admin-email').value, document.getElementById('admin-pass').value)
            .catch(err => alert("ভুল তথ্য!"));
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- PRODUCT UPLOAD & EDIT LOGIC ---
        const form = document.getElementById('upload-form');
        let isEditing = false;

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const data = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                category: document.getElementById('book-category').value, // Category
                price: document.getElementById('book-price').value,
                image: document.getElementById('book-image').value,
                description: document.getElementById('book-desc').value,
                createdAt: serverTimestamp()
            };

            try {
                if (isEditing) {
                    // Update existing
                    const id = document.getElementById('edit-id').value;
                    await updateDoc(doc(db, "products", id), data);
                    alert("আপডেট সফল হয়েছে!");
                    resetForm();
                } else {
                    // Add new
                    await addDoc(collection(db, "products"), data);
                    alert("বই যুক্ত হয়েছে!");
                    form.reset();
                }
                loadAdminBooks();
            } catch(err) { alert(err.message); }
        });

        // Load Books for Admin
        async function loadAdminBooks() {
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('admin-book-list');
            list.innerHTML = '';
            
            snap.forEach(d => {
                const book = d.data();
                const div = document.createElement('div');
                div.style = "background: white; padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between;";
                div.innerHTML = `
                    <span><b>${book.title}</b> (${book.category}) - ৳${book.price}</span>
                    <div>
                        <button class="edit-btn" onclick="startEdit('${d.id}', '${book.title}', '${book.author}', '${book.category}', '${book.price}', '${book.image}')">Edit</button>
                        <button class="delete-btn" onclick="deleteBook('${d.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Edit Helper (Global function)
        window.startEdit = (id, title, author, cat, price, img) => {
            isEditing = true;
            document.getElementById('edit-id').value = id;
            document.getElementById('book-title').value = title;
            document.getElementById('book-author').value = author;
            document.getElementById('book-category').value = cat;
            document.getElementById('book-price').value = price;
            document.getElementById('book-image').value = img;
            
            // Description needs separate fetch or passing carefully (simplified here)
            document.getElementById('submit-btn').innerText = "আপডেট করুন";
            document.getElementById('cancel-edit').style.display = "block";
            window.scrollTo(0,0);
        };

        // Reset Form
        function resetForm() {
            isEditing = false;
            form.reset();
            document.getElementById('submit-btn').innerText = "আপলোড করুন";
            document.getElementById('cancel-edit').style.display = "none";
        }
        document.getElementById('cancel-edit').addEventListener('click', resetForm);

        // Delete Helper
        window.deleteBook = async (id) => {
            if(confirm("বইটি ডিলিট করতে চান?")) {
                await deleteDoc(doc(db, "products", id));
                loadAdminBooks();
            }
        };

        // Section Switcher
        window.showSection = (sec) => {
            document.getElementById('sec-products').style.display = 'none';
            document.getElementById('sec-banners').style.display = 'none';
            document.getElementById('sec-' + sec).style.display = 'block';
        };

        // Banner Logic
        document.getElementById('banner-form').addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(collection(db, "banners"), { 
                image: document.getElementById('banner-img').value, 
                createdAt: serverTimestamp() 
            });
            alert("ব্যানার যুক্ত হয়েছে");
            e.target.reset();
        });
    </script>
</body>
</html>
