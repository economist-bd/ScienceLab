<script type="module">
        import { db, doc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, limit } from './firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const container = document.getElementById('details-container');
        const relatedSection = document.getElementById('related-products-section');
        const relatedList = document.getElementById('related-list');

        console.log("Product Page Loaded. Product ID:", productId); // ডিবাগিং

        async function loadProduct() {
            // ১. আইডি না থাকলে হোম পেইজে ফেরত পাঠাবে বা এরর দেখাবে
            if (!productId) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 50px;">
                        <h3>কোনো বই সিলেক্ট করা হয়নি!</h3>
                        <p>দয়া করে <a href="index.html" style="color:var(--primary);">হোম পেইজ</a> থেকে একটি বই সিলেক্ট করুন।</p>
                    </div>`;
                return;
            }

            try {
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("Product Found:", docSnap.data()); // ডিবাগিং
                    const data = docSnap.data();
                    
                    container.innerHTML = `
                        <div class="details-img">
                            <img src="${data.image}" alt="${data.title}">
                        </div>
                        <div class="details-info">
                            <h1 style="color: var(--primary);">${data.title}</h1>
                            <p style="font-size: 16px; color: #555;">লেখক: <b>${data.author || 'অজানা'}</b></p>
                            <p style="font-size: 14px; background: #e0f7fa; display: inline-block; padding: 3px 10px; border-radius: 15px; color: var(--primary);">
                                ${formatCategory(data.category)}
                            </p>
                            
                            <span class="price-tag" style="margin-top: 15px;">৳ ${data.price}</span>

                            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-top: 20px;">
                                <h3 style="margin-bottom: 15px;">অর্ডার করতে আপনার তথ্য দিন:</h3>
                                <form id="order-form">
                                    <input type="text" id="name" class="admin-input" placeholder="আপনার নাম" required>
                                    <input type="tel" id="phone" class="admin-input" placeholder="মোবাইল নম্বর" required>
                                    <input type="text" id="address" class="admin-input" placeholder="সম্পূর্ণ ঠিকানা" required>
                                    <button type="submit" class="buy-btn">অর্ডার কনফার্ম করুন</button>
                                </form>
                            </div>

                            <div style="margin-top: 30px;">
                                <h3>বইয়ের বিবরণ</h3>
                                <div class="desc-text" style="color: #444;">${data.description ? data.description : 'কোনো বিবরণ নেই।'}</div>
                            </div>
                        </div>
                    `;

                    // অর্ডার লজিক
                    document.getElementById('order-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const btn = e.target.querySelector('button');
                        btn.innerText = "প্রসেসিং...";
                        btn.disabled = true;

                        try {
                            await addDoc(collection(db, "orders"), {
                                productId: productId,
                                product: data.title,
                                price: data.price,
                                customerName: document.getElementById('name').value,
                                phone: document.getElementById('phone').value,
                                address: document.getElementById('address').value,
                                status: 'Pending',
                                date: serverTimestamp()
                            });
                            alert("অর্ডার সফল হয়েছে!");
                            window.location.href = "index.html";
                        } catch (error) {
                            alert("অর্ডার ব্যর্থ হয়েছে: " + error.message);
                            btn.disabled = false;
                        }
                    });

                    // রিলেটেড প্রোডাক্ট লোড
                    if (data.category) loadRelatedProducts(data.category, productId);

                } else {
                    container.innerHTML = "<p>বইটি ডাটাবেজে নেই (ভুল আইডি)।</p>";
                }
            } catch (err) {
                console.error("Firebase Error:", err);
                container.innerHTML = `<p style="color:red;">সমস্যা হয়েছে: ${err.message}.<br> আপনি কি লোকাল সার্ভার ব্যবহার করছেন?</p>`;
            }
        }

        async function loadRelatedProducts(category, currentId) {
            try {
                const q = query(collection(db, "products"), where("category", "==", category), limit(6));
                const snap = await getDocs(q);
                if (snap.size > 1 || (snap.size === 1 && snap.docs[0].id !== currentId)) {
                    relatedSection.style.display = 'block';
                    relatedList.innerHTML = '';
                    snap.forEach(doc => {
                        if (doc.id !== currentId) {
                            const rData = doc.data();
                            relatedList.innerHTML += `
                                <a href="product.html?id=${doc.id}" class="product-card" style="min-width: 160px;">
                                    <img src="${rData.image}" class="product-img" style="height: 200px;">
                                    <div class="product-info">
                                        <h3 class="product-title" style="font-size: 14px;">${rData.title}</h3>
                                        <div class="product-price" style="font-size: 16px;">৳ ${rData.price}</div>
                                    </div>
                                </a>`;
                        }
                    });
                }
            } catch (e) { console.log("Related product load error", e); }
        }

        function formatCategory(cat) {
            const map = {'HSC': 'HSC একাডেমিক', 'Admission': 'এডমিশন টেস্ট', 'Science': 'বিজ্ঞান', 'Novel': 'উপন্যাস', 'History': 'ইতিহাস'};
            return map[cat] || cat;
        }

        loadProduct();
    </script>
